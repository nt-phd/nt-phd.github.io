<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCCQ - Questionario sullo scompenso cardiaco</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

    <style>
        /* Radio button — alto contrasto tramite variabili Bootstrap */
        .form-check-input {
            width: 1.25em;
            height: 1.25em;
            border: 2px solid var(--bs-dark);
            cursor: pointer;
        }
        .form-check-input:checked {
            background-color: var(--bs-dark);
            border-color: var(--bs-dark);
        }
        .form-check-input:focus {
            border-color: var(--bs-dark);
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-dark-rgb), 0.25);
        }

        /* Hover sulle opzioni a griglia */
        .option-label {
            transition: background-color .15s;
        }
        .option-label:hover {
            background-color: var(--bs-tertiary-bg);
        }

        /* Stampa */
        @media print {
            body {
                font-size: 11pt;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .container { max-width: 100%; padding: 0; margin: 0; }
            .bg-body-tertiary { background-color: #fff !important; }
            .shadow-sm { box-shadow: none !important; }
            .rounded-3 { border-radius: 0 !important; }
            .btn { display: none !important; }
            #result-box { display: none !important; }
            h1 { font-size: 18pt; }
            .lead { font-size: 11pt; }

            .form-check-input {
                border: 2px solid #000 !important;
                width: 1.2em;
                height: 1.2em;
                appearance: none;
                -webkit-appearance: none;
                background: #fff !important;
                border-radius: 50%;
            }
            .form-check-input:checked {
                background: #000 !important;
                border-color: #000 !important;
            }

            .table td, .table th {
                border: 1px solid #000 !important;
                padding: 4px 6px;
            }
            .table-striped > tbody > tr:nth-of-type(odd) {
                background-color: #eee !important;
            }

            .form-group {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // ⚙️ Incolla qui l'URL del tuo Google Apps Script Web App dopo averlo deployato
            const APPS_SCRIPT_URL = 'INSERISCI_QUI_URL_APPS_SCRIPT';

            const questions = [
                {
                    label: "1. Lo scompenso cardiaco influisce su persone diverse in modo diverso. Alcuni hanno difficoltà a respirare mentre altri si sentono stanchi. Per cortesia indichi quanto lo scompenso cardiaco (difficoltà a respirare o stanchezza) ha limitato la sua capacità di fare le seguenti attività nelle ultime 2 settimane.",
                    activities: ["Vestirsi", "Fare il bagno o la doccia", "Camminare in piano per circa 100 metri", "Fare piccoli lavori di giardinaggio o intorno alla casa, lavori domestici, portare la spesa", "Fare una decina di scalini a piedi senza fermarsi", "Affrettarsi o correre (come per prendere l'autobus)"],
                    options: ["Estremamente limitato", "Molto limitato", "Moderatamente limitato", "Poco limitato", "Per niente limitato", "Limitato per altre ragioni"]
                },
                {
                    label: "2. Rispetto a 2 settimane fa i suoi sintomi di scompenso cardiaco (difficoltà a respirare, stanchezza o gonfiore alle caviglie) sono cambiati?",
                    options: ["Molto peggiorati", "Un po' peggiorati", "Non sono cambiati", "Un po' migliorati", "Molto migliorati", "Nessun sintomo nelle ultime 2 settimane"]
                },
                {
                    label: "3. Nelle ultime 2 settimane, quante volte si è alzato/a la mattina con i piedi, le caviglie o le gambe gonfie?",
                    options: ["Ogni mattina", "3 o più volte alla settimana ma non ogni giorno", "1 o 2 volte alla settimana", "Meno di 1 volta alla settimana", "Mai nelle ultime 2 settimane"]
                },
                {
                    label: "4. Nelle ultime 2 settimane, quanto le ha dato fastidio il gonfiore ai piedi, alle caviglie o alle gambe?",
                    options: ["Estremamente fastidio", "Molto fastidio", "Moderatamente fastidio", "Poco fastidio", "Per niente fastidio", "Non ho avuto gonfiore"]
                },
                {
                    label: "5. Nelle ultime 2 settimane, quante volte in media la stanchezza ha limitato la sua capacità di fare quello che desiderava?",
                    options: ["Sempre", "Parecchie volte al giorno", "Almeno 1 volta al giorno", "3 o più volte alla settimana", "1 o 2 volte alla settimana", "Meno di 1 volta alla settimana", "Mai nelle ultime 2 settimane"]
                },
                {
                    label: "6. Nelle ultime 2 settimane, quanto le ha dato fastidio sentirsi stanco/a?",
                    options: ["Estremamente fastidio", "Molto fastidio", "Moderatamente fastidio", "Poco fastidio", "Per niente fastidio", "Non mi sono sentito/a stanco/a"]
                },
                {
                    label: "7. Nelle ultime 2 settimane, quante volte in media la difficoltà a respirare ha limitato la sua capacità di fare quello che desiderava?",
                    options: ["Sempre", "Parecchie volte al giorno", "Almeno 1 volta al giorno", "3 o più volte alla settimana", "1 o 2 volte alla settimana", "Meno di 1 volta alla settimana", "Mai nelle ultime 2 settimane"]
                },
                {
                    label: "8. Nelle ultime 2 settimane, quanto le ha dato fastidio la difficoltà a respirare?",
                    options: ["Estremamente fastidio", "Molto fastidio", "Moderatamente fastidio", "Poco fastidio", "Per niente fastidio", "Non ho avuto difficoltà a respirare"]
                },
                {
                    label: "9. Nelle ultime 2 settimane, quante volte in media è stato/a costretto/a a dormire su una sedia o con almeno tre cuscini dietro la schiena a causa della difficoltà a respirare?",
                    options: ["Ogni notte", "3 o più volte alla settimana ma non ogni giorno", "1 o 2 volte alla settimana", "Meno di 1 volta alla settimana", "Mai nelle ultime 2 settimane"]
                },
                {
                    label: "10. I sintomi di scompenso cardiaco possono peggiorare per varie ragioni. In che misura è sicuro/a di sapere cosa fare o chi chiamare, se i suoi sintomi peggiorano?",
                    options: ["Per niente sicuro/a", "Non molto sicuro/a", "Abbastanza sicuro/a", "Quasi del tutto sicuro/a", "Completamente sicuro/a"]
                },
                {
                    label: "11. Quanto le è chiaro cosa può fare affinché i suoi sintomi di scompenso cardiaco non peggiorino (per esempio: pesarsi, mangiare con poco sale nella dieta, ecc.)?",
                    options: ["Per niente chiaro", "Non molto chiaro", "Abbastanza chiaro", "Quasi del tutto chiaro", "Completamente chiaro"]
                },
                {
                    label: "12. Nelle ultime 2 settimane, quanto lo scompenso cardiaco ha limitato il suo piacere di vivere?",
                    options: ["Ha limitato estremamente il mio piacere di vivere", "Ha limitato molto il mio piacere di vivere", "Ha limitato moderatamente il mio piacere di vivere", "Ha limitato poco il mio piacere di vivere", "Non ha limitato per niente il mio piacere di vivere"]
                },
                {
                    label: "13. Come si sentirebbe se sapesse di dover passare il resto della sua vita con lo scompenso cardiaco al livello in cui è adesso?",
                    options: ["Per niente soddisfatto/a", "Per lo più soddisfatto/a", "Abbastanza soddisfatto/a", "Quasi del tutto soddisfatto/a", "Completamente soddisfatto/a"]
                },
                {
                    label: "14. Nelle ultime 2 settimane, quanto spesso si è sentito/a scoraggiato/a o giù di morale a causa dello scompenso cardiaco?",
                    options: ["Mi sono sempre sentito/a così", "Mi sono sentito/a così spesso", "Mi sono sentito/a così qualche volta", "Mi sono sentito/a così raramente", "Non mi sono mai sentito/a così"]
                },
                {
                    label: "15. In che misura lo scompenso cardiaco influisce sul suo stile di vita? Per cortesia, indichi quanto lo scompenso cardiaco può aver limitato la sua partecipazione alle seguenti attività nelle ultime 2 settimane.",
                    activities: ["Passatempi, attività di svago", "Lavorare o fare dei lavori in casa", "Andare a trovare amici o familiari", "Relazioni intime con la persona amata"],
                    options: ["Estremamente limitato", "Molto limitato", "Moderatamente limitato", "Poco limitato", "Per niente limitato", "Non è il mio caso o non l'ho fatto per altre ragioni"]
                }
            ];

            const form = document.querySelector("form");
            const questionsContainer = document.getElementById("questions-container");

            questions.forEach((question, index) => {
                let questionDiv = document.createElement("div");
                questionDiv.classList.add("form-group", "mb-4", "pb-3", "border-bottom");
                questionDiv.innerHTML = `<p class="fw-semibold mb-3">${question.label}</p>`;

                if (!question.activities) {
                    // Griglia Bootstrap con colonne equidistanti
                    let optionsRow = document.createElement("div");
                    optionsRow.classList.add("row", "g-2", "text-center");

                    question.options.forEach((option, optIdx) => {
                        let optionIndex = optIdx + 1;
                        let inputId = `q${index + 1}_option${optionIndex}`;
                        let col = document.createElement("div");
                        col.classList.add("col");
                        col.innerHTML = `
                            <label for="${inputId}" class="option-label d-flex flex-column align-items-center gap-1 p-2 rounded cursor-pointer">
                                <span class="small">${option}</span>
                                <input class="form-check-input mt-0" type="radio" id="${inputId}" name="q${index + 1}" value="${optionIndex}">
                            </label>
                        `;
                        optionsRow.appendChild(col);
                    });

                    questionDiv.appendChild(optionsRow);
                }

                if (question.activities) {
                    // Tabella per domande con attività (dati genuinamente tabulari)
                    let wrapper = document.createElement("div");
                    wrapper.classList.add("table-responsive");

                    let table = document.createElement("table");
                    table.classList.add("table", "table-hover", "table-striped", "table-bordered", "align-middle", "mb-0");

                    let headerHTML = `<thead class="table-light"><tr><th scope="col">Attività</th>`;
                    question.options.forEach(option => {
                        headerHTML += `<th scope="col" class="text-center fw-normal small">${option}</th>`;
                    });
                    headerHTML += `</tr></thead>`;

                    let bodyHTML = '<tbody>';
                    question.activities.forEach((activity, actIndex) => {
                        bodyHTML += `<tr><th scope="row" class="fw-normal">${activity}</th>`;
                        for (let i = 1; i <= question.options.length; i++) {
                            let inputId = `q${index + 1}_${actIndex + 1}_${i}`;
                            let val = i === 6 ? 0 : i;
                            bodyHTML += `<td class="text-center">
                                <label for="${inputId}" class="d-block m-0 py-1" role="button">
                                    <input class="form-check-input mt-0" type="radio" id="${inputId}" name="q${index + 1}_${actIndex + 1}" value="${val}">
                                </label>
                            </td>`;
                        }
                        bodyHTML += `</tr>`;
                    });
                    bodyHTML += '</tbody>';

                    table.innerHTML = headerHTML + bodyHTML;
                    wrapper.appendChild(table);
                    questionDiv.appendChild(wrapper);
                }

                questionsContainer.appendChild(questionDiv);
            });

            const resultBox = document.getElementById("result-box");

            form.addEventListener("submit", function (event) {
                event.preventDefault();

                const nome = document.getElementById('nome').value.trim();
                const cognome = document.getElementById('cognome').value.trim();
                const dataNascita = document.getElementById('data_nascita').value;
                const dataEsecuzione = new Date().toLocaleDateString('it-IT');

                let formData = new FormData(form);

                let domainScores = {
                    'physical_limitations': 0,
                    'symptoms': 0,
                    'self_efficacy_and_knowledge': 0,
                    'quality_of_life': 0,
                    'social_interference': 0
                };

                let domainQuestions = {
                    'physical_limitations': ['q1_1', 'q1_2', 'q1_3', 'q1_4', 'q1_5', 'q1_6'],
                    'symptoms': ['q2', 'q3', 'q4', 'q5', 'q6', 'q7', 'q8', 'q9'],
                    'self_efficacy_and_knowledge': ['q10', 'q11'],
                    'quality_of_life': ['q12', 'q13', 'q14'],
                    'social_interference': ['q15_1', 'q15_2', 'q15_3', 'q15_4']
                };

                let domainCounts = {
                    'physical_limitations': 0,
                    'symptoms': 0,
                    'self_efficacy_and_knowledge': 0,
                    'quality_of_life': 0,
                    'social_interference': 0
                };

                // Assign default values for unanswered questions
                Object.keys(domainQuestions).forEach(domain => {
                    domainQuestions[domain].forEach(question => {
                        if (!formData.has(question) || formData.get(question) === "") {
                            formData.set(question, '0');
                        }
                    });
                });

                // Calculate initial scores and counts for answered questions
                formData.forEach((value, key) => {
                    Object.keys(domainQuestions).forEach(domain => {
                        if (domainQuestions[domain].includes(key)) {
                            let intValue = parseInt(value);
                            if (intValue > 0) {
                                domainScores[domain] += intValue;
                                domainCounts[domain]++;
                            }
                        }
                    });
                });

                // Calculate averages for each domain
                let domainAverages = {};
                Object.keys(domainScores).forEach(domain => {
                    domainAverages[domain] = domainCounts[domain] > 0 ? domainScores[domain] / domainCounts[domain] : 0;
                });

                // Reset scores and counts for the final calculation
                Object.keys(domainScores).forEach(domain => {
                    domainScores[domain] = 0;
                    domainCounts[domain] = 0;
                });

                // Calculate final scores using real values or averages for unanswered questions
                formData.forEach((value, key) => {
                    Object.keys(domainQuestions).forEach(domain => {
                        if (domainQuestions[domain].includes(key)) {
                            let intValue = parseInt(value);
                            if (intValue > 0) {
                                domainScores[domain] += intValue;
                            } else {
                                domainScores[domain] += domainAverages[domain];
                            }
                            domainCounts[domain]++;
                        }
                    });
                });

                if (Object.values(domainScores).every(score => score > 0)) {
                    let minScore = 0;
                    let maxScore = 0;

                    Object.keys(domainQuestions).forEach(domain => {
                        domainQuestions[domain].forEach(question => {
                            minScore += 1;
                            const options = document.querySelectorAll(`input[name="${question}"]`);
                            maxScore += Math.max(...[...options].map(o => +o.value));
                        });
                    });

                    let sumScores = Object.values(domainScores).reduce((total, score) => total + score, 0);
                    let kccqScore = Math.round((sumScores - minScore) / (maxScore - minScore) * 100);

                    let resultHTML = `Punteggio KCCQ di <b>${nome} ${cognome}</b> (${dataEsecuzione}): <b>${kccqScore}/100</b>`;

                    resultBox.innerHTML = resultHTML;
                    resultBox.style.display = 'block';
                    resultBox.classList.add('alert-success');
                    resultBox.classList.remove('alert-danger');

                    // Popola i campi stampa
                    document.getElementById('print-nome').textContent = `${nome} ${cognome}`;
                    document.getElementById('print-data').textContent = dataEsecuzione;

                    // Invio dati a Google Sheets
                    if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'INSERISCI_QUI_URL_APPS_SCRIPT') {
                        fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                nome,
                                cognome,
                                dataNascita,
                                dataEsecuzione,
                                punteggioKCCQ: kccqScore
                            })
                        }).catch(err => console.error('Errore invio dati:', err));
                    }

                } else {
                    resultBox.innerHTML = '<b>Errore</b>: è necessario che lei risponda a più domande per calcolare il suo punteggio KCCQ.';
                    resultBox.style.display = 'block';
                    resultBox.classList.remove('alert-success');
                    resultBox.classList.add('alert-danger');
                }
            });
        });
    </script>
</head>

<body class="bg-body-tertiary">
    <main class="container my-4 my-md-5">
        <div class="bg-body p-4 p-md-5 rounded-3 shadow-sm">
            <h1 class="mb-3">Questionario sullo scompenso cardiaco</h1>
            <p class="lead text-body-secondary mb-4">Le seguenti domande si riferiscono al suo scompenso cardiaco e a come esso influisce sulla sua
                vita. Per cortesia legga e completi le seguenti domande. Non ci sono risposte giuste o sbagliate. Selezioni
                la risposta che meglio descrive la sua situazione.</p>
            <form id="questionnaire-form">
                <div class="mb-4 pb-3 border-bottom">
                    <p class="fw-semibold mb-3">Dati del paziente</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="nome" class="form-label">Nome <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nome" name="nome" required placeholder="Mario">
                        </div>
                        <div class="col-md-4">
                            <label for="cognome" class="form-label">Cognome <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cognome" name="cognome" required placeholder="Rossi">
                        </div>
                        <div class="col-md-4">
                            <label for="data_nascita" class="form-label">Data di nascita <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="data_nascita" name="data_nascita" required>
                        </div>
                    </div>
                </div>

                <div class="d-none d-print-flex justify-content-between border-bottom pb-2 mb-4">
                    <div><strong>Nome:</strong> <span id="print-nome"></span></div>
                    <div><strong>Data:</strong> <span id="print-data"></span></div>
                </div>
                <div id="questions-container"></div>
                <div id="result-box" class="alert" style="display: none;"></div>
                <button type="submit" class="btn btn-dark btn-lg">Calcola Punteggio</button>
            </form>
        </div>
    </main>

    <footer class="container mb-5">
        <div class="small text-body-secondary px-4">
            <h6 class="fw-semibold">Riferimenti</h6>
            <p class="mb-1">Green CP, Porter CB, Bresnahan DR, Spertus JA. Development and evaluation of the Kansas City Cardiomyopathy
                Questionnaire: a new health status measure for heart failure. J Am Coll Cardiol. 2000 Apr;35(5):1245-55.
                doi: 10.1016/s0735-1097(00)00531-3. PMID: 10758967.</p>
            <p class="mb-1">Miani D, Rozbowsky P, Gregori D, Pilotto L, Albanese MC, Fresco C, Fioretti PM. The Kansas City
                Cardiomyopathy Questionnaire: Italian translation and validation. Ital Heart J. 2003 Sep;4(9):620-6. PMID:
                14635380.</p>
            <p>Tutti i diritti riservati ai rispettivi autori.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
</body>

</html>
