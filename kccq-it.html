<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCCQ - Questionario sullo scompenso cardiaco</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://www.google.com/recaptcha/api.js?render=explicit&onload=initRecaptcha" async defer></script>

    <style>
        /* Radio button — alto contrasto tramite variabili Bootstrap */
        .form-check-input {
            width: 1.25em;
            height: 1.25em;
            border: 2px solid var(--bs-dark);
            cursor: pointer;
        }
        .form-check-input:checked {
            background-color: var(--bs-dark);
            border-color: var(--bs-dark);
        }
        .form-check-input:focus {
            border-color: var(--bs-dark);
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-dark-rgb), 0.25);
        }

        /* Hover sulle opzioni a griglia */
        .option-label {
            transition: background-color .15s;
        }
        .option-label:hover {
            background-color: var(--bs-tertiary-bg);
        }

        /* Stampa */
        @media print {
            body {
                font-size: 11pt;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .container { max-width: 100%; padding: 0; margin: 0; }
            .bg-body-tertiary { background-color: #fff !important; }
            .shadow-sm { box-shadow: none !important; }
            .rounded-3 { border-radius: 0 !important; }
            .btn { display: none !important; }
            #result-box { display: none !important; }
            h1 { font-size: 18pt; }
            .lead { font-size: 11pt; }

            .form-check-input {
                border: 2px solid #000 !important;
                width: 1.2em;
                height: 1.2em;
                appearance: none;
                -webkit-appearance: none;
                background: #fff !important;
                border-radius: 50%;
            }
            .form-check-input:checked {
                background: #000 !important;
                border-color: #000 !important;
            }

            .table td, .table th {
                border: 1px solid #000 !important;
                padding: 4px 6px;
            }
            .table-striped > tbody > tr:nth-of-type(odd) {
                background-color: #eee !important;
            }

            .form-group {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>

    <script>
        // ⚙️ Configurazione — modifica questi due valori
        const APPS_SCRIPT_URL = 'https://script.google.com/a/macros/ospedaliriuniti.marche.it/s/AKfycbxDJEyl1779EJgADJC-GoEsTUHyXyYEVrIXVO919qYty1mZl1pay6XjfYS0pwksSQ/exec';
        const RECAPTCHA_SITE_KEY = '6Lcsp28sAAAAAGia-FK1TN3sOzAqZdXoZSBYoGpX';

        // reCAPTCHA — variabili di stato
        let recaptchaWidgetId;
        let pendingSubmission = null;

        function initRecaptcha() {
            if (RECAPTCHA_SITE_KEY === 'INSERISCI_QUI_SITE_KEY_RECAPTCHA') return;
            recaptchaWidgetId = grecaptcha.render('recaptcha-container', {
                sitekey: RECAPTCHA_SITE_KEY,
                size: 'invisible',
                callback: onCaptchaSuccess
            });
        }

        function onCaptchaSuccess(token) {
            if (!pendingSubmission) return;
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...pendingSubmission, recaptchaToken: token })
            }).catch(err => console.error('Errore invio dati:', err));
            pendingSubmission = null;
            grecaptcha.reset(recaptchaWidgetId);
        }

        document.addEventListener("DOMContentLoaded", function () {

            // Evita che il browser ripristini i valori del form tra le sessioni
            document.getElementById('nome').value = '';
            document.getElementById('cognome').value = '';
            document.getElementById('data_nascita').value = '';
            document.getElementById('sei_minuti').value = '';

            const questions = [
                {
                    label: "1. Lo scompenso cardiaco influisce su persone diverse in modo diverso. Alcuni hanno difficoltà a respirare mentre altri si sentono stanchi. Per cortesia indichi quanto lo scompenso cardiaco (difficoltà a respirare o stanchezza) ha limitato la sua capacità di fare le seguenti attività nelle ultime 2 settimane.",
                    activities: ["Vestirsi", "Fare il bagno o la doccia", "Camminare in piano per circa 100 metri", "Fare piccoli lavori di giardinaggio o intorno alla casa, lavori domestici, portare la spesa", "Fare una decina di scalini a piedi senza fermarsi", "Affrettarsi o correre (come per prendere l'autobus)"],
                    options: ["Estremamente limitato", "Molto limitato", "Moderatamente limitato", "Poco limitato", "Per niente limitato", "Limitato per altre ragioni"]
                },
                {
                    label: "2. Rispetto a 2 settimane fa i suoi sintomi di scompenso cardiaco (difficoltà a respirare, stanchezza o gonfiore alle caviglie) sono cambiati?",
                    options: ["Molto peggiorati", "Un po' peggiorati", "Non sono cambiati", "Un po' migliorati", "Molto migliorati", "Nessun sintomo nelle ultime 2 settimane"]
                },
                {
                    label: "3. Nelle ultime 2 settimane, quante volte si è alzato/a la mattina con i piedi, le caviglie o le gambe gonfie?",
                    options: ["Ogni mattina", "3 o più volte alla settimana ma non ogni giorno", "1 o 2 volte alla settimana", "Meno di 1 volta alla settimana", "Mai nelle ultime 2 settimane"]
                },
                {
                    label: "4. Nelle ultime 2 settimane, quanto le ha dato fastidio il gonfiore ai piedi, alle caviglie o alle gambe?",
                    options: ["Estremamente fastidio", "Molto fastidio", "Moderatamente fastidio", "Poco fastidio", "Per niente fastidio", "Non ho avuto gonfiore"]
                },
                {
                    label: "5. Nelle ultime 2 settimane, quante volte in media la stanchezza ha limitato la sua capacità di fare quello che desiderava?",
                    options: ["Sempre", "Parecchie volte al giorno", "Almeno 1 volta al giorno", "3 o più volte alla settimana", "1 o 2 volte alla settimana", "Meno di 1 volta alla settimana", "Mai nelle ultime 2 settimane"]
                },
                {
                    label: "6. Nelle ultime 2 settimane, quanto le ha dato fastidio sentirsi stanco/a?",
                    options: ["Estremamente fastidio", "Molto fastidio", "Moderatamente fastidio", "Poco fastidio", "Per niente fastidio", "Non mi sono sentito/a stanco/a"]
                },
                {
                    label: "7. Nelle ultime 2 settimane, quante volte in media la difficoltà a respirare ha limitato la sua capacità di fare quello che desiderava?",
                    options: ["Sempre", "Parecchie volte al giorno", "Almeno 1 volta al giorno", "3 o più volte alla settimana", "1 o 2 volte alla settimana", "Meno di 1 volta alla settimana", "Mai nelle ultime 2 settimane"]
                },
                {
                    label: "8. Nelle ultime 2 settimane, quanto le ha dato fastidio la difficoltà a respirare?",
                    options: ["Estremamente fastidio", "Molto fastidio", "Moderatamente fastidio", "Poco fastidio", "Per niente fastidio", "Non ho avuto difficoltà a respirare"]
                },
                {
                    label: "9. Nelle ultime 2 settimane, quante volte in media è stato/a costretto/a a dormire su una sedia o con almeno tre cuscini dietro la schiena a causa della difficoltà a respirare?",
                    options: ["Ogni notte", "3 o più volte alla settimana ma non ogni giorno", "1 o 2 volte alla settimana", "Meno di 1 volta alla settimana", "Mai nelle ultime 2 settimane"]
                },
                {
                    label: "10. I sintomi di scompenso cardiaco possono peggiorare per varie ragioni. In che misura è sicuro/a di sapere cosa fare o chi chiamare, se i suoi sintomi peggiorano?",
                    options: ["Per niente sicuro/a", "Non molto sicuro/a", "Abbastanza sicuro/a", "Quasi del tutto sicuro/a", "Completamente sicuro/a"]
                },
                {
                    label: "11. Quanto le è chiaro cosa può fare affinché i suoi sintomi di scompenso cardiaco non peggiorino (per esempio: pesarsi, mangiare con poco sale nella dieta, ecc.)?",
                    options: ["Per niente chiaro", "Non molto chiaro", "Abbastanza chiaro", "Quasi del tutto chiaro", "Completamente chiaro"]
                },
                {
                    label: "12. Nelle ultime 2 settimane, quanto lo scompenso cardiaco ha limitato il suo piacere di vivere?",
                    options: ["Ha limitato estremamente il mio piacere di vivere", "Ha limitato molto il mio piacere di vivere", "Ha limitato moderatamente il mio piacere di vivere", "Ha limitato poco il mio piacere di vivere", "Non ha limitato per niente il mio piacere di vivere"]
                },
                {
                    label: "13. Come si sentirebbe se sapesse di dover passare il resto della sua vita con lo scompenso cardiaco al livello in cui è adesso?",
                    options: ["Per niente soddisfatto/a", "Per lo più soddisfatto/a", "Abbastanza soddisfatto/a", "Quasi del tutto soddisfatto/a", "Completamente soddisfatto/a"]
                },
                {
                    label: "14. Nelle ultime 2 settimane, quanto spesso si è sentito/a scoraggiato/a o giù di morale a causa dello scompenso cardiaco?",
                    options: ["Mi sono sempre sentito/a così", "Mi sono sentito/a così spesso", "Mi sono sentito/a così qualche volta", "Mi sono sentito/a così raramente", "Non mi sono mai sentito/a così"]
                },
                {
                    label: "15. In che misura lo scompenso cardiaco influisce sul suo stile di vita? Per cortesia, indichi quanto lo scompenso cardiaco può aver limitato la sua partecipazione alle seguenti attività nelle ultime 2 settimane.",
                    activities: ["Passatempi, attività di svago", "Lavorare o fare dei lavori in casa", "Andare a trovare amici o familiari", "Relazioni intime con la persona amata"],
                    options: ["Estremamente limitato", "Molto limitato", "Moderatamente limitato", "Poco limitato", "Per niente limitato", "Non è il mio caso o non l'ho fatto per altre ragioni"]
                }
            ];

            const form = document.querySelector("form");
            const questionsContainer = document.getElementById("questions-container");

            questions.forEach((question, index) => {
                let questionDiv = document.createElement("div");
                questionDiv.classList.add("form-group", "mb-4", "pb-3", "border-bottom");
                questionDiv.innerHTML = `<p class="fw-semibold mb-3">${question.label}</p>`;

                if (!question.activities) {
                    // Griglia Bootstrap con colonne equidistanti
                    let optionsRow = document.createElement("div");
                    optionsRow.classList.add("row", "g-2", "text-center");

                    question.options.forEach((option, optIdx) => {
                        let optionIndex = optIdx + 1;
                        let inputId = `q${index + 1}_option${optionIndex}`;
                        let col = document.createElement("div");
                        col.classList.add("col");
                        col.innerHTML = `
                            <label for="${inputId}" class="option-label d-flex flex-column align-items-center gap-1 p-2 rounded cursor-pointer">
                                <span class="small">${option}</span>
                                <input class="form-check-input mt-0" type="radio" id="${inputId}" name="q${index + 1}" value="${optionIndex}">
                            </label>
                        `;
                        optionsRow.appendChild(col);
                    });

                    questionDiv.appendChild(optionsRow);
                }

                if (question.activities) {
                    // Tabella per domande con attività (dati genuinamente tabulari)
                    let wrapper = document.createElement("div");
                    wrapper.classList.add("table-responsive");

                    let table = document.createElement("table");
                    table.classList.add("table", "table-hover", "table-striped", "table-bordered", "align-middle", "mb-0");

                    let headerHTML = `<thead class="table-light"><tr><th scope="col">Attività</th>`;
                    question.options.forEach(option => {
                        headerHTML += `<th scope="col" class="text-center fw-normal small">${option}</th>`;
                    });
                    headerHTML += `</tr></thead>`;

                    let bodyHTML = '<tbody>';
                    question.activities.forEach((activity, actIndex) => {
                        bodyHTML += `<tr><th scope="row" class="fw-normal">${activity}</th>`;
                        for (let i = 1; i <= question.options.length; i++) {
                            let inputId = `q${index + 1}_${actIndex + 1}_${i}`;
                            let val = i === 6 ? 0 : i;
                            bodyHTML += `<td class="text-center">
                                <label for="${inputId}" class="d-block m-0 py-1" role="button">
                                    <input class="form-check-input mt-0" type="radio" id="${inputId}" name="q${index + 1}_${actIndex + 1}" value="${val}">
                                </label>
                            </td>`;
                        }
                        bodyHTML += `</tr>`;
                    });
                    bodyHTML += '</tbody>';

                    table.innerHTML = headerHTML + bodyHTML;
                    wrapper.appendChild(table);
                    questionDiv.appendChild(wrapper);
                }

                questionsContainer.appendChild(questionDiv);
            });

            const resultBox = document.getElementById("result-box");

            form.addEventListener("submit", function (event) {
                event.preventDefault();

                const nome = document.getElementById('nome').value.trim();
                const cognome = document.getElementById('cognome').value.trim();
                const dataNascitaRaw = document.getElementById('data_nascita').value;
                const dataNascita = dataNascitaRaw ? dataNascitaRaw.split('-').reverse().join('/') : '';
                const dataEsecuzione = new Date().toLocaleDateString('it-IT');
                const seiMinutiRaw = document.getElementById('sei_minuti').value.trim();
                const seiMinuti = seiMinutiRaw !== '' ? parseInt(seiMinutiRaw) : null;

                let formData = new FormData(form);

                // ── KCCQ Overall Summary Score (algoritmo ufficiale) ──────────────────
                // Riferimenti: Green et al. JACC 2000; Spertus et al. Circ Cardiovasc
                // Qual Outcomes 2015 (KCCQ-12); FDA MDDT Qualification Document.
                //
                // OSS = media di 4 punteggi di dominio (peso uguale per dominio):
                //   Physical Limitation · Total Symptom Score · QoL · Social Limitation
                // Self-Efficacy (q10-q11) e Symptom Stability (q2) ESCLUSI dall'OSS.
                //
                // Formula per dominio: mean[(item_value − 1) / (item_max − 1)] × 100
                //   dove item_max è il massimo della scala di scoring (non quello HTML).
                // Missing data: item non risposti o "non applicabile" (val=0) vengono
                //   esclusi dalla media del dominio (equivale a imputation con media).
                // ─────────────────────────────────────────────────────────────────────

                const kccqDomainItems = {
                    physical_limitation: ['q1_1','q1_2','q1_3','q1_4','q1_5','q1_6'],
                    symptom_frequency:   ['q3','q5','q7','q9'],
                    symptom_burden:      ['q4','q6','q8'],
                    quality_of_life:     ['q12','q13','q14'],
                    social_limitation:   ['q15_1','q15_2','q15_3','q15_4']
                };

                // Massimo della scala di scoring per item (ufficiale KCCQ).
                // q4, q6, q8: il 6° option HTML è "nessun sintomo" → trattato come
                //   massimo (5), non come un 6° punto della scala.
                // q5, q7: scala genuina a 7 punti (frequenza).
                const kccqItemMax = {
                    q1_1:5, q1_2:5, q1_3:5, q1_4:5, q1_5:5, q1_6:5,
                    q3:5, q4:5, q5:7, q6:5, q7:7, q8:5, q9:5,
                    q12:5, q13:5, q14:5,
                    q15_1:5, q15_2:5, q15_3:5, q15_4:5
                };

                // Punteggio 0-100 per un dominio (media degli item risposti).
                function kccqDomainScore(data, items) {
                    const scores = [];
                    for (const item of items) {
                        const val = parseInt(data.get(item) || '0');
                        if (val > 0) {
                            const maxVal = kccqItemMax[item];
                            // Math.min gestisce "nessun sintomo" (val > maxVal → 100%)
                            scores.push(Math.min(1.0, (val - 1) / (maxVal - 1)));
                        }
                    }
                    if (scores.length === 0) return null;
                    return (scores.reduce((a, b) => a + b, 0) / scores.length) * 100;
                }

                const kccqPL  = kccqDomainScore(formData, kccqDomainItems.physical_limitation);
                const kccqSF  = kccqDomainScore(formData, kccqDomainItems.symptom_frequency);
                const kccqSB  = kccqDomainScore(formData, kccqDomainItems.symptom_burden);
                const kccqQoL = kccqDomainScore(formData, kccqDomainItems.quality_of_life);
                const kccqSL  = kccqDomainScore(formData, kccqDomainItems.social_limitation);

                if ([kccqPL, kccqSF, kccqSB, kccqQoL, kccqSL].every(s => s !== null)) {
                    const totalSymptomScore = (kccqSF + kccqSB) / 2;
                    const kccqScore = Math.round((kccqPL + totalSymptomScore + kccqQoL + kccqSL) / 4);

                    const nameDisplay = (nome && cognome) ? ` di <b>${nome} ${cognome}</b>` : '';
                    const seiMinutiDisplay = seiMinuti !== null ? ` &nbsp;·&nbsp; 6MWT: <b>${seiMinuti} m</b>` : '';
                    resultBox.innerHTML = `Punteggio KCCQ${nameDisplay} (${dataEsecuzione}): <b>${kccqScore}/100</b>${seiMinutiDisplay}`;
                    resultBox.style.display = 'block';
                    resultBox.classList.add('alert-success');
                    resultBox.classList.remove('alert-danger');

                    // Popola i campi stampa
                    document.getElementById('print-nome').textContent = (nome && cognome) ? `${nome} ${cognome}` : '';
                    document.getElementById('print-data').textContent = dataEsecuzione;

                    // Invio dati a Google Sheets solo se tutti i dati paziente sono compilati
                    const tuttiIDatiCompilati = nome && cognome && dataNascita;
                    if (tuttiIDatiCompilati && APPS_SCRIPT_URL !== 'INSERISCI_QUI_URL_APPS_SCRIPT') {
                        const dati = { nome, cognome, dataNascita, dataEsecuzione, punteggioKCCQ: kccqScore, seiMinutiTest: seiMinuti ?? '' };
                        if (recaptchaWidgetId !== undefined) {
                            // Invio tramite reCAPTCHA invisibile
                            pendingSubmission = dati;
                            grecaptcha.execute(recaptchaWidgetId);
                        } else {
                            // reCAPTCHA non configurato — invio diretto
                            fetch(APPS_SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(dati)
                            }).catch(err => console.error('Errore invio dati:', err));
                        }
                    }

                } else {
                    resultBox.innerHTML = '<b>Errore</b>: è necessario che lei risponda a più domande per calcolare il suo punteggio KCCQ.';
                    resultBox.style.display = 'block';
                    resultBox.classList.remove('alert-success');
                    resultBox.classList.add('alert-danger');
                }
            });
        });
    </script>
</head>

<body class="bg-body-tertiary">
    <main class="container my-4 my-md-5">
        <div class="bg-body p-4 p-md-5 rounded-3 shadow-sm">
            <h1 class="mb-3">Questionario sullo scompenso cardiaco</h1>
            <p class="lead text-body-secondary mb-4">Le seguenti domande si riferiscono al suo scompenso cardiaco e a come esso influisce sulla sua
                vita. Per cortesia legga e completi le seguenti domande. Non ci sono risposte giuste o sbagliate. Selezioni
                la risposta che meglio descrive la sua situazione.</p>
            <form id="questionnaire-form">
                <div class="mb-4 pb-3 border-bottom">
                    <p class="fw-semibold mb-3">Inserisca il suo nome, cognome, e data di nascita per registrare il risultato.</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="nome" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="nome" name="nome" autocomplete="off">
                        </div>
                        <div class="col-md-4">
                            <label for="cognome" class="form-label">Cognome</label>
                            <input type="text" class="form-control" id="cognome" name="cognome" autocomplete="off">
                        </div>
                        <div class="col-md-4">
                            <label for="data_nascita" class="form-label">Data di nascita</label>
                            <input type="date" class="form-control" id="data_nascita" name="data_nascita" autocomplete="off">
                        </div>
                        <div class="col-md-4">
                            <label for="sei_minuti" class="form-label">Test del cammino dei 6 minuti <span class="text-body-secondary fw-normal">(facoltativo)</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="sei_minuti" name="sei_minuti" min="0" max="2000" placeholder="es. 420" autocomplete="off">
                                <span class="input-group-text">m</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-none d-print-flex justify-content-between border-bottom pb-2 mb-4">
                    <div><strong>Nome:</strong> <span id="print-nome"></span></div>
                    <div><strong>Data:</strong> <span id="print-data"></span></div>
                </div>
                <div id="questions-container"></div>
                <div id="result-box" class="alert" style="display: none;"></div>
                <div id="recaptcha-container"></div>
                <button type="submit" class="btn btn-dark btn-lg">Calcola Punteggio</button>
            </form>
        </div>
    </main>

    <footer class="container mb-5">
        <div class="small text-body-secondary px-4">
            <h6 class="fw-semibold">Riferimenti</h6>
            <p class="mb-1">Green CP, Porter CB, Bresnahan DR, Spertus JA. Development and evaluation of the Kansas City Cardiomyopathy
                Questionnaire: a new health status measure for heart failure. J Am Coll Cardiol. 2000 Apr;35(5):1245-55.
                doi: 10.1016/s0735-1097(00)00531-3. PMID: 10758967.</p>
            <p class="mb-1">Miani D, Rozbowsky P, Gregori D, Pilotto L, Albanese MC, Fresco C, Fioretti PM. The Kansas City
                Cardiomyopathy Questionnaire: Italian translation and validation. Ital Heart J. 2003 Sep;4(9):620-6. PMID:
                14635380.</p>
            <p>Tutti i diritti riservati ai rispettivi autori.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
</body>

</html>
